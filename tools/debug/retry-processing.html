<!DOCTYPE html>
<html>
<head>
    <title>Retry Processing</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .recording {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .retry-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .retry-btn:hover {
            background: #218838;
        }
        .retry-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .status {
            padding: 20px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Retry Processing</h1>
        <p>If your video has been stuck processing for more than 20 minutes, you can manually retry the processing.</p>
        
        <div id="recordings-container">
            <div class="status info">
                <h3>üîç Loading stuck recordings...</h3>
                <p>Searching for recordings that need retry...</p>
            </div>
        </div>
        
        <div id="retry-status"></div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        
        const SUPABASE_URL = "https://qinkldgvejheppheykfl.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpbmtsZGd2ZWpoZXBwaGV5a2ZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk1OTA0NDcsImV4cCI6MjA2NTE2NjQ0N30.xn9c-6Sr_kEbETzafRrlaWMHgbUIoqifsCQBrqYT7u4";
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        async function loadStuckRecordings() {
            try {
                const { data: { user }, error: authError } = await supabase.auth.getUser();
                if (authError || !user) {
                    document.getElementById('recordings-container').innerHTML = `
                        <div class="status error">
                            <h3>üîê Authentication Required</h3>
                            <p>Please log in first to retry processing.</p>
                        </div>
                    `;
                    return;
                }
                
                // Find recordings that are stuck (older than 20 minutes and still processing)
                const twentyMinutesAgo = new Date(Date.now() - 20 * 60 * 1000).toISOString();
                
                const { data: recordings, error } = await supabase
                    .from('recordings')
                    .select('id, title, file_size, status, created_at, updated_at, error_message')
                    .in('status', ['pending', 'processing', 'transcribing', 'processing_large_file', 'uploading'])
                    .lt('created_at', twentyMinutesAgo)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    throw error;
                }
                
                if (!recordings || recordings.length === 0) {
                    document.getElementById('recordings-container').innerHTML = `
                        <div class="status info">
                            <h3>‚úÖ No Stuck Recordings</h3>
                            <p>All recordings appear to be processing normally or have completed.</p>
                            <p>If you have a recording that's been pending for more than 20 minutes, try refreshing the main dashboard first.</p>
                        </div>
                    `;
                    return;
                }
                
                const recordingsHTML = recordings.map(recording => {
                    const fileSizeMB = recording.file_size ? (recording.file_size / (1024 * 1024)).toFixed(2) : 'Unknown';
                    const createdAgo = getTimeAgo(new Date(recording.created_at));
                    
                    return `
                        <div class="recording">
                            <h4>üìÅ ${recording.title}</h4>
                            <p><strong>Size:</strong> ${fileSizeMB}MB | <strong>Status:</strong> ${recording.status} | <strong>Created:</strong> ${createdAgo}</p>
                            ${recording.error_message ? `<p style="color: #721c24;"><strong>Error:</strong> ${recording.error_message}</p>` : ''}
                            <button class="retry-btn" onclick="retryProcessing('${recording.id}', '${recording.title}')">
                                üîÑ Retry Processing
                            </button>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('recordings-container').innerHTML = `
                    <div class="status info">
                        <h3>‚ö†Ô∏è Found ${recordings.length} Stuck Recording${recordings.length > 1 ? 's' : ''}</h3>
                        <p>These recordings have been processing for more than 20 minutes and may be stuck.</p>
                    </div>
                    ${recordingsHTML}
                `;
                
            } catch (error) {
                console.error('Error loading recordings:', error);
                document.getElementById('recordings-container').innerHTML = `
                    <div class="status error">
                        <h3>‚ùå Error Loading Recordings</h3>
                        <p>Failed to load recordings: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function retryProcessing(recordingId, title) {
            const statusDiv = document.getElementById('retry-status');
            
            try {
                statusDiv.innerHTML = `
                    <div class="status info">
                        <h3>üîÑ Retrying Processing...</h3>
                        <p>Sending "${title}" for reprocessing...</p>
                    </div>
                `;
                
                // First reset the status
                const { error: resetError } = await supabase
                    .from('recordings')
                    .update({ 
                        status: 'pending',
                        error_message: null,
                        processing_notes: 'Manual retry requested'
                    })
                    .eq('id', recordingId);
                
                if (resetError) {
                    throw resetError;
                }
                
                // Then trigger reprocessing
                const { data, error } = await supabase.functions.invoke('process-recording', {
                    body: { recording_id: recordingId }
                });
                
                if (error) {
                    throw error;
                }
                
                statusDiv.innerHTML = `
                    <div class="status success">
                        <h3>‚úÖ Retry Successful!</h3>
                        <p>"${title}" has been queued for reprocessing.</p>
                        <p>Check the status monitor or refresh your dashboard in a few minutes.</p>
                    </div>
                `;
                
                // Reload the stuck recordings list
                setTimeout(loadStuckRecordings, 2000);
                
            } catch (error) {
                console.error('Retry failed:', error);
                statusDiv.innerHTML = `
                    <div class="status error">
                        <h3>‚ùå Retry Failed</h3>
                        <p>Failed to retry processing for "${title}": ${error.message}</p>
                        <p>You may need to check the Azure OpenAI configuration or try again later.</p>
                    </div>
                `;
            }
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMins / 60);
            
            if (diffMins < 60) return `${diffMins} minutes ago`;
            return `${diffHours} hours ago`;
        }
        
        // Make function globally available
        window.retryProcessing = retryProcessing;
        
        // Load stuck recordings on page load
        loadStuckRecordings();
    </script>
</body>
</html>